<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengeluaran</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --secondary: #2d3748;
            --accent: #3182ce;
            --accent-light: #63b3ed;
            --text: #e2e8f0;
            --text-light: #a0aec0;
            --danger: #e53e3e;
            --success: #38a169;
            --border: #4a5568;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--primary);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2rem;
            color: var(--accent-light);
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background-color: var(--accent-light);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--accent);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--secondary);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(49, 130, 206, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-light);
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .card-desc {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .card-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .trend-up {
            color: var(--success);
        }
        
        .trend-down {
            color: var(--danger);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .table-container {
            background-color: var(--secondary);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            color: var(--text-light);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .category-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            background-color: rgba(49, 130, 206, 0.2);
            color: var(--accent-light);
        }
        
        .chart-container {
            background-color: var(--secondary);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-select {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 15px;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 15px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>Dashboard Pengeluaran</h1>
            </div>
            <div class="controls">
                <button class="btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button class="btn btn-outline" id="exportBtn">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>
        </header>
        
        <div class="filters">
            <select class="filter-select" id="categoryFilter">
                <option value="">Semua Kategori</option>
            </select>
            <select class="filter-select" id="monthFilter">
                <option value="">Semua Bulan</option>
            </select>
            <select class="filter-select" id="sortBy">
                <option value="date-desc">Tanggal: Terbaru</option>
                <option value="date-asc">Tanggal: Terlama</option>
                <option value="price-desc">Harga: Tertinggi</option>
                <option value="price-asc">Harga: Terendah</option>
                <option value="name">Nama Barang: A-Z</option>
            </select>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Total Pengeluaran</div>
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div class="card-value" id="totalExpense">Rp 0</div>
                <div class="card-desc">Total semua pengeluaran</div>
                <div class="card-trend trend-up">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12% dari bulan lalu</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Rata-rata per Item</div>
                    <div class="card-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                </div>
                <div class="card-value" id="avgExpense">Rp 0</div>
                <div class="card-desc">Rata-rata harga per barang</div>
                <div class="card-trend trend-down">
                    <i class="fas fa-arrow-down"></i>
                    <span>-5% dari bulan lalu</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Jumlah Barang</div>
                    <div class="card-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>
                <div class="card-value" id="itemCount">0</div>
                <div class="card-desc">Total barang yang dibeli</div>
                <div class="card-trend trend-up">
                    <i class="fas fa-arrow-up"></i>
                    <span>+3 dari bulan lalu</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="card-title">Daftar Pengeluaran</h2>
                    <div class="card-desc" id="tableInfo">Menampilkan 0 dari 0 item</div>
                </div>
                <div class="loading" id="tableLoading">
                    <div class="spinner"></div>
                    <div>Memuat data...</div>
                </div>
                <table id="expenseTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Nama Barang</th>
                            <th>Tanggal</th>
                            <th>Kategori</th>
                            <th>Harga</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="chart-container">
                <h2 class="chart-title">Pengeluaran per Kategori</h2>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi
        const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrWYpFckR6C9Yzbh1GoPHasCYVcafjFeWwZY3o2kY-9efIK1r7iZhFXrUbGB3GTBmHfRyRsrckiSxb/pub?gid=0&single=true&output=csv";
        
        // Variabel global
        let expenseData = [];
        let filteredData = [];
        let categoryChart = null;
        
        // Format angka ke Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // Parse tanggal dari string
        function parseDate(dateString) {
            try {
                // Format: "Sabtu, November 29, 2025"
                const months = {
                    'Januari': 0, 'Februari': 1, 'Maret': 2, 'April': 3, 'Mei': 4, 'Juni': 5,
                    'Juli': 6, 'Agustus': 7, 'September': 8, 'Oktober': 9, 'November': 10, 'Desember': 11
                };
                
                const parts = dateString.split(' ');
                const day = parseInt(parts[2].replace(',', ''));
                const month = months[parts[1]];
                const year = parseInt(parts[3]);
                
                return new Date(year, month, day);
            } catch (error) {
                console.error('Error parsing date:', dateString, error);
                return new Date(); // Return tanggal hari ini jika parsing gagal
            }
        }
        
        // Parse harga dari string
        function parsePrice(priceString) {
            try {
                // Format: "Rp 491.777,00" atau "491.777,00"
                const numericString = priceString
                    .replace('Rp', '')
                    .replace(/\./g, '')
                    .replace(',', '.')
                    .trim();
                    
                return parseFloat(numericString);
            } catch (error) {
                console.error('Error parsing price:', priceString, error);
                return 0;
            }
        }
        
        // Parse CSV dengan penanganan yang lebih baik
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            // Cari baris header untuk mengetahui struktur data
            let headerIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('Name') && lines[i].includes('Barang') && 
                    lines[i].includes('Tanggal') && lines[i].includes('Kategori') && 
                    lines[i].includes('Harga')) {
                    headerIndex = i;
                    break;
                }
            }
            
            // Jika tidak menemukan header yang sesuai, coba gunakan baris pertama
            if (headerIndex === -1) headerIndex = 0;
            
            // Proses data mulai dari baris setelah header
            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Split dengan koma, tetapi perhatikan field yang mungkin mengandung koma
                const columns = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        columns.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                columns.push(current);
                
                // Jika ada minimal 5 kolom, anggap sebagai data valid
                if (columns.length >= 5) {
                    const item = {
                        name: columns[0]?.trim() || '',
                        barang: columns[1]?.trim() || '',
                        tanggal: columns[2]?.trim() || '',
                        kategori: columns[3]?.trim() || '',
                        harga: parsePrice(columns[4]?.trim() || '0')
                    };
                    
                    // Hanya tambahkan jika ada data barang
                    if (item.barang) {
                        result.push(item);
                    }
                }
            }
            
            return result;
        }
        
        // Ambil data dari spreadsheet
        async function fetchData() {
            try {
                document.getElementById('tableLoading').style.display = 'flex';
                document.getElementById('expenseTable').style.display = 'none';
                
                const response = await fetch(SPREADSHEET_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV Data:', csvText); // Untuk debugging
                
                // Parse CSV
                expenseData = parseCSV(csvText);
                
                // Jika tidak ada data, gunakan data contoh
                if (expenseData.length === 0) {
                    console.warn('Tidak ada data dari spreadsheet, menggunakan data contoh');
                    expenseData = [
                        { name: '1', barang: 'Koper', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 491777 },
                        { name: '2', barang: 'Power Bank', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 184071 },
                        { name: '3', barang: 'Kotak Bento', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 123879 },
                        { name: '4', barang: 'Tumbler', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 91400 },
                        { name: '5', barang: 'Payung Lipat', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 42471 },
                        { name: '6', barang: 'Colokan Type A', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 25750 },
                        { name: '7', barang: 'Kabel Data Type C', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 31360 },
                        { name: '8', barang: 'Set Alat Makan', tanggal: 'Sabtu, November 29, 2025', kategori: 'Akomodasi', harga: 21000 }
                    ];
                }
                
                console.log('Parsed Data:', expenseData); // Untuk debugging
                
                updateDashboard();
                updateFilters();
                applyFilters();
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('tableLoading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #e53e3e;"></i>
                    <div>Gagal memuat data. Pastikan URL spreadsheet valid.</div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #a0aec0;">Error: ${error.message}</div>
                `;
            }
        }
        
        // Perbarui dashboard dengan data terbaru
        function updateDashboard() {
            // Hitung statistik
            const totalExpense = expenseData.reduce((sum, item) => sum + item.harga, 0);
            const avgExpense = expenseData.length > 0 ? totalExpense / expenseData.length : 0;
            const itemCount = expenseData.length;
            
            // Update card values
            document.getElementById('totalExpense').textContent = formatRupiah(totalExpense);
            document.getElementById('avgExpense').textContent = formatRupiah(avgExpense);
            document.getElementById('itemCount').textContent = itemCount;
            
            // Update chart
            updateChart();
        }
        
        // Perbarui chart
        function updateChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Hapus chart lama jika ada
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            // Kelompokkan data berdasarkan kategori
            const categories = {};
            expenseData.forEach(item => {
                if (categories[item.kategori]) {
                    categories[item.kategori] += item.harga;
                } else {
                    categories[item.kategori] = item.harga;
                }
            });
            
            // Siapkan data untuk chart
            const labels = Object.keys(categories);
            const data = Object.values(categories);
            
            // Buat chart baru
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3182ce', '#63b3ed', '#90cdf4', '#bee3f8',
                            '#4299e1', '#2b6cb0', '#2c5282', '#1a365d'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e2e8f0',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatRupiah(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Perbarui filter options
        function updateFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            const monthFilter = document.getElementById('monthFilter');
            
            // Dapatkan kategori unik
            const categories = [...new Set(expenseData.map(item => item.kategori))];
            
            // Kosongkan dan isi ulang filter kategori
            categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            // Dapatkan bulan unik
            const months = [...new Set(expenseData.map(item => {
                try {
                    const date = parseDate(item.tanggal);
                    return `${date.getFullYear()}-${date.getMonth()}`;
                } catch (error) {
                    return 'unknown';
                }
            }))].filter(month => month !== 'unknown');
            
            // Kosongkan dan isi ulang filter bulan
            monthFilter.innerHTML = '<option value="">Semua Bulan</option>';
            months.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthNames = [
                    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                ];
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${monthNames[parseInt(monthNum)]} ${year}`;
                monthFilter.appendChild(option);
            });
        }
        
        // Terapkan filter
        function applyFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            // Filter data
            filteredData = expenseData.filter(item => {
                const categoryMatch = !categoryFilter || item.kategori === categoryFilter;
                
                let monthMatch = true;
                if (monthFilter) {
                    try {
                        const date = parseDate(item.tanggal);
                        const itemMonth = `${date.getFullYear()}-${date.getMonth()}`;
                        monthMatch = itemMonth === monthFilter;
                    } catch (error) {
                        monthMatch = false;
                    }
                }
                
                return categoryMatch && monthMatch;
            });
            
            // Urutkan data
            filteredData.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return parseDate(b.tanggal) - parseDate(a.tanggal);
                    case 'date-asc':
                        return parseDate(a.tanggal) - parseDate(b.tanggal);
                    case 'price-desc':
                        return b.harga - a.harga;
                    case 'price-asc':
                        return a.harga - b.harga;
                    case 'name':
                        return a.barang.localeCompare(b.barang);
                    default:
                        return 0;
                }
            });
            
            // Tampilkan data
            displayData();
        }
        
        // Tampilkan data di tabel
        function displayData() {
            const tableBody = document.getElementById('expenseTableBody');
            tableBody.innerHTML = '';
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.barang}</td>
                    <td>${item.tanggal}</td>
                    <td><span class="category-badge">${item.kategori}</span></td>
                    <td>${formatRupiah(item.harga)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update info tabel
            document.getElementById('tableInfo').textContent = 
                `Menampilkan ${filteredData.length} dari ${expenseData.length} item`;
            
            // Sembunyikan loading, tampilkan tabel
            document.getElementById('tableLoading').style.display = 'none';
            document.getElementById('expenseTable').style.display = 'table';
        }
        
        // Export data ke CSV
        function exportToCSV() {
            const headers = ['Nama Barang', 'Tanggal', 'Kategori', 'Harga'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(item => [
                    `"${item.barang}"`,
                    `"${item.tanggal}"`,
                    `"${item.kategori}"`,
                    item.harga
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'laporan_pengeluaran.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', fetchData);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('monthFilter').addEventListener('change', applyFilters);
        document.getElementById('sortBy').addEventListener('change', applyFilters);
        
        // Inisialisasi
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
